# ğŸ“Š Diagramas de Flujo Detallados

## 1. Flujo de AutenticaciÃ³n Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Usuario   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. Click "Iniciar con Google"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. signInWithOAuth()
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase   â”‚
â”‚    Auth     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. Redirige a Google OAuth
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Google    â”‚
â”‚    OAuth    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. Usuario autoriza
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase   â”‚
â”‚    Auth     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. Retorna JWT token
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚
â”‚  /callback  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 6. POST /auth/initialize
       â”‚    { token: "jwt..." }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Backend   â”‚
â”‚  GuiaIPN    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â†’ 7a. Verifica token con Supabase
       â”‚
       â”œâ”€â†’ 7b. Crea perfil en tabla 'profiles'
       â”‚
       â”œâ”€â†’ 7c. Inicializa 'user_progress' (8 materias)
       â”‚
       â”‚ 8. Retorna perfil creado
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 9. Guarda token + redirige a /dashboard
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dashboard  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Flujo de Pregunta con Streaming (Detallado)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚                â”‚  Backend â”‚                â”‚   Redis  â”‚                â”‚ Supabase â”‚                â”‚  OpenAI  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚ 1. socket.emit(           â”‚                           â”‚                           â”‚                           â”‚
     â”‚    'ask_question',        â”‚                           â”‚                           â”‚                           â”‚
     â”‚    {token, question})     â”‚                           â”‚                           â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 2. Verificar token        â”‚                           â”‚                           â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 3. Obtener/crear sesiÃ³n   â”‚                           â”‚                           â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚                           â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                           â”‚
     â”‚                           â”‚   session_id              â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 4. Validar pregunta       â”‚                           â”‚                           â”‚
     â”‚                           â”‚    (5-1000 chars)         â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 5. Normalizar texto       â”‚                           â”‚                           â”‚
     â”‚                           â”‚    (lowercase, trim,      â”‚                           â”‚                           â”‚
     â”‚                           â”‚     remove accents)       â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 6. Generar hash SHA256    â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 7. Buscar en cache        â”‚                           â”‚                           â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚   SELECT * FROM           â”‚                           â”‚                           â”‚
     â”‚                           â”‚   ai_answers WHERE        â”‚                           â”‚                           â”‚
     â”‚                           â”‚   question_hash = ?       â”‚                           â”‚                           â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 8a. Si NO existe:         â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚ 9. waiting_phrase         â”‚                           â”‚                           â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                           â”‚                           â”‚
     â”‚ "Analizando tu pregunta"  â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 10. Generar con OpenAI    â”‚                           â”‚                           â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚   POST /chat/completions  â”‚                           â”‚                           â”‚
     â”‚                           â”‚   {model: "gpt-4",        â”‚                           â”‚                           â”‚
     â”‚                           â”‚    messages: [...]}       â”‚                           â”‚                           â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚   JSON response           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 11. Parsear JSON          â”‚                           â”‚                           â”‚
     â”‚                           â”‚     Validar estructura    â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 12. Guardar en DB         â”‚                           â”‚                           â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚   INSERT INTO ai_answers  â”‚                           â”‚                           â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 8b. Si existe:            â”‚                           â”‚                           â”‚
     â”‚                           â”‚     Incrementar uso       â”‚                           â”‚                           â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚   UPDATE ai_answers       â”‚                           â”‚                           â”‚
     â”‚                           â”‚   SET times_used += 1     â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 13. Actualizar sesiÃ³n     â”‚                           â”‚                           â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚                           â”‚
     â”‚                           â”‚   HSET session:uuid       â”‚                           â”‚                           â”‚
     â”‚                           â”‚   current_question hash   â”‚                           â”‚                           â”‚
     â”‚                           â”‚   is_streaming true       â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚ 14. explanation_start     â”‚                           â”‚                           â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                           â”‚                           â”‚
     â”‚ {total_steps: 4,          â”‚                           â”‚                           â”‚                           â”‚
     â”‚  estimated_duration: 120} â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 15. Iniciar streaming     â”‚                           â”‚                           â”‚
     â”‚                           â”‚     (loop por cada paso)  â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚ 16. step_start            â”‚                           â”‚                           â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                           â”‚                           â”‚
     â”‚ {step: 0,                 â”‚                           â”‚                           â”‚                           â”‚
     â”‚  title: "DefiniciÃ³n",     â”‚                           â”‚                           â”‚                           â”‚
     â”‚  type: "text"}            â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 17. Dividir contenido     â”‚                           â”‚                           â”‚
     â”‚                           â”‚     en chunks de 50 chars â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚ 18. content_chunk (x N)   â”‚                           â”‚                           â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                           â”‚                           â”‚
     â”‚ {step: 0,                 â”‚                           â”‚                           â”‚                           â”‚
     â”‚  chunk: "La energÃ­a...",  â”‚                           â”‚                           â”‚                           â”‚
     â”‚  position: 0,             â”‚                           â”‚                           â”‚                           â”‚
     â”‚  is_final: false}         â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ (delay 50ms)              â”‚                           â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                           â”‚                           â”‚
     â”‚ {chunk: "cinÃ©tica es..."}â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 19. Si hay canvas_commandsâ”‚                           â”‚                           â”‚
     â”‚ 20. canvas_command        â”‚                           â”‚                           â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                           â”‚                           â”‚
     â”‚ {step: 0,                 â”‚                           â”‚                           â”‚                           â”‚
     â”‚  command: {type: "draw_   â”‚                           â”‚                           â”‚                           â”‚
     â”‚  axis", x: 50, y: 200}}   â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚ 21. step_complete         â”‚                           â”‚                           â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                           â”‚                           â”‚
     â”‚ {step: 0}                 â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚ [Repetir 16-21 para       â”‚                           â”‚                           â”‚                           â”‚
     â”‚  cada paso restante]      â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚ 22. explanation_complete  â”‚                           â”‚                           â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚                           â”‚                           â”‚
     â”‚ {total_duration: 120,     â”‚                           â”‚                           â”‚                           â”‚
     â”‚  steps_completed: 4}      â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 23. Actualizar sesiÃ³n     â”‚                           â”‚                           â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚                           â”‚
     â”‚                           â”‚   HSET session:uuid       â”‚                           â”‚                           â”‚
     â”‚                           â”‚   is_streaming false      â”‚                           â”‚                           â”‚
     â”‚                           â”‚   EXPIRE session:uuid     â”‚                           â”‚                           â”‚
     â”‚                           â”‚   1800                    â”‚                           â”‚                           â”‚
```

---

## 3. Flujo de Pause/Resume

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚                â”‚  Backend â”‚                â”‚   Redis  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚                           â”‚
     â”‚ [Streaming en progreso]   â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 1. Usuario click "Pausar" â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 2. socket.emit(           â”‚                           â”‚
     â”‚    'pause_explanation')   â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 3. Obtener sesiÃ³n         â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 4. Actualizar estado      â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚   HSET session:uuid       â”‚
     â”‚                           â”‚   is_paused true          â”‚
     â”‚                           â”‚   pause_position 150      â”‚
     â”‚                           â”‚   is_streaming false      â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 5. Detener loop streaming â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 6. explanation_paused     â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ {message: "Pausado",      â”‚                           â”‚
     â”‚  session_id: "uuid"}      â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ [Usuario espera...]       â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 7. Usuario click "Reanudar"â”‚                          â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 8. socket.emit(           â”‚                           â”‚
     â”‚    'resume_explanation')  â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 9. Obtener sesiÃ³n         â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚   {pause_position: 150,   â”‚
     â”‚                           â”‚    current_step: 2}       â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 10. Actualizar estado     â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚   HSET session:uuid       â”‚
     â”‚                           â”‚   is_paused false         â”‚
     â”‚                           â”‚   is_streaming true       â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 11. streaming_resumed     â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ {step: 2,                 â”‚                           â”‚
     â”‚  position: 150}           â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 12. Continuar desde       â”‚
     â”‚                           â”‚     posiciÃ³n 150          â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 13. content_chunk         â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ (continÃºa streaming)      â”‚                           â”‚
```

---

## 4. Flujo de Pregunta de Examen

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚                â”‚  Backend â”‚                â”‚ Supabase â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚                           â”‚
     â”‚ 1. GET /questions/random  â”‚                           â”‚
     â”‚    ?subject=matematicas   â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 2. SELECT random pregunta â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚ 3. Retorna pregunta       â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ {id, question_text,       â”‚                           â”‚
     â”‚  option_a, option_b, ...} â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 4. Usuario selecciona "a" â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 5. POST /questions/{id}/  â”‚                           â”‚
     â”‚    answer                 â”‚                           â”‚
     â”‚    {user_answer: "a"}     â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 6. Validar respuesta      â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚ 7. Retorna resultado      â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ {is_correct: true,        â”‚                           â”‚
     â”‚  correct_answer: "a"}     â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 8. Usuario click          â”‚                           â”‚
     â”‚    "Ver explicaciÃ³n"      â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 9. socket.emit(           â”‚                           â”‚
     â”‚    'start_explanation',   â”‚                           â”‚
     â”‚    {question_id,          â”‚                           â”‚
     â”‚     user_answer})         â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 10. Buscar explicaciÃ³n    â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚   SELECT * FROM           â”‚
     â”‚                           â”‚   exam_explanations       â”‚
     â”‚                           â”‚   WHERE question_id = ?   â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 11a. Si NO existe:        â”‚
     â”‚                           â”‚      Generar con IA       â”‚
     â”‚                           â”‚      Guardar en DB        â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 12. waiting_phrase        â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 13. explanation_start     â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ [Streaming normal...]     â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 14. explanation_complete  â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 15. Mostrar botones:      â”‚                           â”‚
     â”‚     - Â¿Fue Ãºtil? ğŸ‘ğŸ‘     â”‚                           â”‚
     â”‚     - Hacer pregunta      â”‚                           â”‚
     â”‚       adicional           â”‚                           â”‚
```

---

## 5. Flujo de Follow-up Question

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚                â”‚  Backend â”‚                â”‚ Supabase â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚                           â”‚
     â”‚ [DespuÃ©s de explicaciÃ³n]  â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 1. Usuario escribe:       â”‚                           â”‚
     â”‚    "Â¿Y en movimiento      â”‚                           â”‚
     â”‚     circular?"            â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 2. socket.emit(           â”‚                           â”‚
     â”‚    'ask_follow_up_        â”‚                           â”‚
     â”‚    question',             â”‚                           â”‚
     â”‚    {question: "...",      â”‚                           â”‚
     â”‚     related_to: "uuid"})  â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 3. Obtener pregunta       â”‚
     â”‚                           â”‚    original               â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 4. Normalizar + hash      â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 5. Buscar en cache        â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 6. Si NO existe:          â”‚
     â”‚                           â”‚    Generar con IA         â”‚
     â”‚                           â”‚    (incluye contexto      â”‚
     â”‚                           â”‚     de pregunta original) â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 7. waiting_phrase         â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 8. Guardar respuesta      â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚   INSERT INTO ai_answers  â”‚
     â”‚                           â”‚   related_question_id =   â”‚
     â”‚                           â”‚   "uuid_original"         â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 9. follow_up_start        â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ {answer_id: "uuid",       â”‚                           â”‚
     â”‚  is_follow_up: true}      â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ [Streaming normal...]     â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 10. follow_up_complete    â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 11. follow_up_options     â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ {options: [               â”‚                           â”‚
     â”‚   'more_questions',       â”‚                           â”‚
     â”‚   'finish']}              â”‚                           â”‚
```

---

## 6. Flujo de InterrupciÃ³n/AclaraciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend â”‚                â”‚  Backend â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚
     â”‚ [Streaming en progreso]   â”‚
     â”‚                           â”‚
     â”‚ 1. Usuario click          â”‚
     â”‚    "No entiendo X"        â”‚
     â”‚                           â”‚
     â”‚ 2. socket.emit(           â”‚
     â”‚    'interrupt_            â”‚
     â”‚    explanation',          â”‚
     â”‚    {clarification_        â”‚
     â”‚     question: "...",      â”‚
     â”‚     current_context})     â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚
     â”‚                           â”‚ 3. Pausar streaming       â”‚
     â”‚                           â”‚    principal              â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 4. clarification_start    â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ {is_brief: true,          â”‚                           â”‚
     â”‚  estimated_duration: 15}  â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 5. Generar aclaraciÃ³n     â”‚
     â”‚                           â”‚    breve con IA           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 6. clarification_chunk    â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ (streaming rÃ¡pido)        â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 7. clarification_complete â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 8. clarification_options  â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ {options: [               â”‚                           â”‚
     â”‚   'continue',             â”‚                           â”‚
     â”‚   'new_question']}        â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 9. Usuario click          â”‚                           â”‚
     â”‚    "Continuar"            â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 10. socket.emit(          â”‚                           â”‚
     â”‚     'resume_explanation') â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ 11. explanation_resumed   â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ [ContinÃºa streaming       â”‚                           â”‚
     â”‚  principal]               â”‚                           â”‚
```

---

## 7. GestiÃ³n de Sesiones Redis

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Socket  â”‚                â”‚  Session â”‚                â”‚   Redis  â”‚
â”‚  Event   â”‚                â”‚  Service â”‚                â”‚          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚                           â”‚
     â”‚ connect                   â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚ create_session()          â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚   HSET session:uuid       â”‚
     â”‚                           â”‚   user_id, connection_id  â”‚
     â”‚                           â”‚   EXPIRE session:uuid     â”‚
     â”‚                           â”‚   1800                    â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚   session_id              â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
     â”‚ connection_established    â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ [Actividad del usuario]   â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ ask_question              â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚ update_session()          â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚   HSET session:uuid       â”‚
     â”‚                           â”‚   current_question hash   â”‚
     â”‚                           â”‚   last_activity now       â”‚
     â”‚                           â”‚   EXPIRE session:uuid     â”‚
     â”‚                           â”‚   1800 (renovar TTL)      â”‚
     â”‚                           â”‚                           â”‚
     â”‚ [30 minutos sin actividad]â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚                           â”‚ TTL expira
     â”‚                           â”‚                           â”‚ Redis elimina
     â”‚                           â”‚                           â”‚ automÃ¡ticamente
     â”‚                           â”‚                           â”‚
     â”‚ disconnect                â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚ end_session()             â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚   DEL session:uuid        â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
```

---

## 8. Cache de Respuestas IA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Preguntaâ”‚                â”‚  Backend â”‚                â”‚ Supabase â”‚
â”‚  Usuario â”‚                â”‚          â”‚                â”‚ ai_answersâ”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                           â”‚                           â”‚
     â”‚ "Â¿QuÃ© es la energÃ­a       â”‚                           â”‚
     â”‚  cinÃ©tica?"               â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 1. Normalizar:            â”‚
     â”‚                           â”‚    "que es la energia     â”‚
     â”‚                           â”‚     cinetica"             â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 2. Hash SHA256:           â”‚
     â”‚                           â”‚    "a1b2c3d4..."          â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 3. Buscar en DB           â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚   SELECT * FROM           â”‚
     â”‚                           â”‚   ai_answers WHERE        â”‚
     â”‚                           â”‚   question_hash =         â”‚
     â”‚                           â”‚   'a1b2c3d4...'           â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 4a. Si existe:            â”‚
     â”‚                           â”‚     - Incrementar uso     â”‚
     â”‚                           â”‚     - Retornar respuesta  â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ 4b. Si NO existe:         â”‚
     â”‚                           â”‚     - Generar con IA      â”‚
     â”‚                           â”‚     - Guardar con hash    â”‚
     â”‚                           â”‚     - Retornar respuesta  â”‚
     â”‚                           â”‚                           â”‚
     â”‚ [Otro usuario hace        â”‚                           â”‚
     â”‚  misma pregunta]          â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚ "Que es la EnergÃ­a        â”‚                           â”‚
     â”‚  CINETICA?"               â”‚                           â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚                           â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ Normalizar â†’ mismo hash   â”‚
     â”‚                           â”‚ "a1b2c3d4..."             â”‚
     â”‚                           â”‚                           â”‚
     â”‚                           â”‚ Buscar â†’ ENCONTRADO       â”‚
     â”‚                           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚
     â”‚                           â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                           â”‚                           â”‚
     â”‚ Respuesta instantÃ¡nea     â”‚                           â”‚
     â”‚ (sin llamar a OpenAI)     â”‚                           â”‚
     â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                           â”‚
```

---

## Leyenda de SÃ­mbolos

```
â”‚   Flujo vertical
â”œâ”€â†’ AcciÃ³n/llamada
â†â”€â”¤ Respuesta/retorno
â–¼   ContinÃºa hacia abajo
[...] Comentario/nota
```
