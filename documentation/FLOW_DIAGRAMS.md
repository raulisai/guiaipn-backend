# ๐ Diagramas de Flujo Detallados

## 1. Flujo de Autenticaciรณn Completo

```
โโโโโโโโโโโโโโโ
โ   Usuario   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 1. Click "Iniciar con Google"
       โผ
โโโโโโโโโโโโโโโ
โ  Frontend   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 2. signInWithOAuth()
       โผ
โโโโโโโโโโโโโโโ
โ  Supabase   โ
โ    Auth     โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 3. Redirige a Google OAuth
       โผ
โโโโโโโโโโโโโโโ
โ   Google    โ
โ    OAuth    โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 4. Usuario autoriza
       โผ
โโโโโโโโโโโโโโโ
โ  Supabase   โ
โ    Auth     โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 5. Retorna JWT token
       โผ
โโโโโโโโโโโโโโโ
โ  Frontend   โ
โ  /callback  โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 6. POST /auth/initialize
       โ    { token: "jwt..." }
       โผ
โโโโโโโโโโโโโโโ
โ   Backend   โ
โ  GuiaIPN    โ
โโโโโโโโฌโโโโโโโ
       โ
       โโโ 7a. Verifica token con Supabase
       โ
       โโโ 7b. Crea perfil en tabla 'profiles'
       โ
       โโโ 7c. Inicializa 'user_progress' (8 materias)
       โ
       โ 8. Retorna perfil creado
       โผ
โโโโโโโโโโโโโโโ
โ  Frontend   โ
โโโโโโโโฌโโโโโโโ
       โ
       โ 9. Guarda token + redirige a /dashboard
       โผ
โโโโโโโโโโโโโโโ
โ  Dashboard  โ
โโโโโโโโโโโโโโโ
```

---

## 2. Flujo de Pregunta con Streaming (Detallado)

```
โโโโโโโโโโโโ                โโโโโโโโโโโโ                โโโโโโโโโโโโ                โโโโโโโโโโโโ                โโโโโโโโโโโโ
โ Frontend โ                โ  Backend โ                โ   Redis  โ                โ Supabase โ                โ  OpenAI  โ
โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ
     โ                           โ                           โ                           โ                           โ
     โ 1. socket.emit(           โ                           โ                           โ                           โ
     โ    'ask_question',        โ                           โ                           โ                           โ
     โ    {token, question})     โ                           โ                           โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 2. Verificar token        โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 3. Obtener/crear sesiรณn   โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ                           โ
     โ                           โ   session_id              โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 4. Validar pregunta       โ                           โ                           โ
     โ                           โ    (5-1000 chars)         โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 5. Normalizar texto       โ                           โ                           โ
     โ                           โ    (lowercase, trim,      โ                           โ                           โ
     โ                           โ     remove accents)       โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 6. Generar hash SHA256    โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 7. Buscar en cache        โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ   SELECT * FROM           โ                           โ                           โ
     โ                           โ   ai_answers WHERE        โ                           โ                           โ
     โ                           โ   question_hash = ?       โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 8a. Si NO existe:         โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ 9. waiting_phrase         โ                           โ                           โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ                           โ                           โ
     โ "Analizando tu pregunta"  โ                           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 10. Generar con OpenAI    โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ   POST /chat/completions  โ                           โ                           โ
     โ                           โ   {model: "gpt-4",        โ                           โ                           โ
     โ                           โ    messages: [...]}       โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ   JSON response           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 11. Parsear JSON          โ                           โ                           โ
     โ                           โ     Validar estructura    โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 12. Guardar en DB         โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ   INSERT INTO ai_answers  โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 8b. Si existe:            โ                           โ                           โ
     โ                           โ     Incrementar uso       โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ   UPDATE ai_answers       โ                           โ                           โ
     โ                           โ   SET times_used += 1     โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 13. Actualizar sesiรณn     โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ                           โ
     โ                           โ   HSET session:uuid       โ                           โ                           โ
     โ                           โ   current_question hash   โ                           โ                           โ
     โ                           โ   is_streaming true       โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ 14. explanation_start     โ                           โ                           โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ                           โ                           โ
     โ {total_steps: 4,          โ                           โ                           โ                           โ
     โ  estimated_duration: 120} โ                           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 15. Iniciar streaming     โ                           โ                           โ
     โ                           โ     (loop por cada paso)  โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ 16. step_start            โ                           โ                           โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ                           โ                           โ
     โ {step: 0,                 โ                           โ                           โ                           โ
     โ  title: "Definiciรณn",     โ                           โ                           โ                           โ
     โ  type: "text"}            โ                           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 17. Dividir contenido     โ                           โ                           โ
     โ                           โ     en chunks de 50 chars โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ 18. content_chunk (x N)   โ                           โ                           โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ                           โ                           โ
     โ {step: 0,                 โ                           โ                           โ                           โ
     โ  chunk: "La energรญa...",  โ                           โ                           โ                           โ
     โ  position: 0,             โ                           โ                           โ                           โ
     โ  is_final: false}         โ                           โ                           โ                           โ
     โ                           โ (delay 50ms)              โ                           โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ                           โ                           โ
     โ {chunk: "cinรฉtica es..."}โ                           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 19. Si hay canvas_commandsโ                           โ                           โ
     โ 20. canvas_command        โ                           โ                           โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ                           โ                           โ
     โ {step: 0,                 โ                           โ                           โ                           โ
     โ  command: {type: "draw_   โ                           โ                           โ                           โ
     โ  axis", x: 50, y: 200}}   โ                           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ 21. step_complete         โ                           โ                           โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ                           โ                           โ
     โ {step: 0}                 โ                           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ [Repetir 16-21 para       โ                           โ                           โ                           โ
     โ  cada paso restante]      โ                           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ 22. explanation_complete  โ                           โ                           โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ                           โ                           โ
     โ {total_duration: 120,     โ                           โ                           โ                           โ
     โ  steps_completed: 4}      โ                           โ                           โ                           โ
     โ                           โ                           โ                           โ                           โ
     โ                           โ 23. Actualizar sesiรณn     โ                           โ                           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ                           โ
     โ                           โ   HSET session:uuid       โ                           โ                           โ
     โ                           โ   is_streaming false      โ                           โ                           โ
     โ                           โ   EXPIRE session:uuid     โ                           โ                           โ
     โ                           โ   1800                    โ                           โ                           โ
```

---

## 3. Flujo de Pause/Resume

```
โโโโโโโโโโโโ                โโโโโโโโโโโโ                โโโโโโโโโโโโ
โ Frontend โ                โ  Backend โ                โ   Redis  โ
โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ
     โ                           โ                           โ
     โ [Streaming en progreso]   โ                           โ
     โ                           โ                           โ
     โ 1. Usuario click "Pausar" โ                           โ
     โ                           โ                           โ
     โ 2. socket.emit(           โ                           โ
     โ    'pause_explanation')   โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ                           โ
     โ                           โ 3. Obtener sesiรณn         โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ                           โ
     โ                           โ 4. Actualizar estado      โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ   HSET session:uuid       โ
     โ                           โ   is_paused true          โ
     โ                           โ   pause_position 150      โ
     โ                           โ   is_streaming false      โ
     โ                           โ                           โ
     โ                           โ 5. Detener loop streaming โ
     โ                           โ                           โ
     โ 6. explanation_paused     โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ {message: "Pausado",      โ                           โ
     โ  session_id: "uuid"}      โ                           โ
     โ                           โ                           โ
     โ [Usuario espera...]       โ                           โ
     โ                           โ                           โ
     โ 7. Usuario click "Reanudar"โ                          โ
     โ                           โ                           โ
     โ 8. socket.emit(           โ                           โ
     โ    'resume_explanation')  โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ                           โ
     โ                           โ 9. Obtener sesiรณn         โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ   {pause_position: 150,   โ
     โ                           โ    current_step: 2}       โ
     โ                           โ                           โ
     โ                           โ 10. Actualizar estado     โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ   HSET session:uuid       โ
     โ                           โ   is_paused false         โ
     โ                           โ   is_streaming true       โ
     โ                           โ                           โ
     โ 11. streaming_resumed     โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ {step: 2,                 โ                           โ
     โ  position: 150}           โ                           โ
     โ                           โ                           โ
     โ                           โ 12. Continuar desde       โ
     โ                           โ     posiciรณn 150          โ
     โ                           โ                           โ
     โ 13. content_chunk         โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ (continรบa streaming)      โ                           โ
```

---

## 4. Flujo de Pregunta de Examen

```
โโโโโโโโโโโโ                โโโโโโโโโโโโ                โโโโโโโโโโโโ
โ Frontend โ                โ  Backend โ                โ Supabase โ
โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ
     โ                           โ                           โ
     โ 1. GET /questions/random  โ                           โ
     โ    ?subject=matematicas   โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ                           โ
     โ                           โ 2. SELECT random pregunta โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ                           โ
     โ 3. Retorna pregunta       โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ {id, question_text,       โ                           โ
     โ  option_a, option_b, ...} โ                           โ
     โ                           โ                           โ
     โ 4. Usuario selecciona "a" โ                           โ
     โ                           โ                           โ
     โ 5. POST /questions/{id}/  โ                           โ
     โ    answer                 โ                           โ
     โ    {user_answer: "a"}     โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ                           โ
     โ                           โ 6. Validar respuesta      โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ                           โ
     โ 7. Retorna resultado      โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ {is_correct: true,        โ                           โ
     โ  correct_answer: "a"}     โ                           โ
     โ                           โ                           โ
     โ 8. Usuario click          โ                           โ
     โ    "Ver explicaciรณn"      โ                           โ
     โ                           โ                           โ
     โ 9. socket.emit(           โ                           โ
     โ    'start_explanation',   โ                           โ
     โ    {question_id,          โ                           โ
     โ     user_answer})         โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ                           โ
     โ                           โ 10. Buscar explicaciรณn    โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ   SELECT * FROM           โ
     โ                           โ   exam_explanations       โ
     โ                           โ   WHERE question_id = ?   โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ                           โ
     โ                           โ 11a. Si NO existe:        โ
     โ                           โ      Generar con IA       โ
     โ                           โ      Guardar en DB        โ
     โ                           โ                           โ
     โ 12. waiting_phrase        โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ
     โ 13. explanation_start     โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ
     โ [Streaming normal...]     โ                           โ
     โ                           โ                           โ
     โ 14. explanation_complete  โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ
     โ 15. Mostrar botones:      โ                           โ
     โ     - ยฟFue รบtil? ๐๐     โ                           โ
     โ     - Hacer pregunta      โ                           โ
     โ       adicional           โ                           โ
```

---

## 5. Flujo de Follow-up Question

```
โโโโโโโโโโโโ                โโโโโโโโโโโโ                โโโโโโโโโโโโ
โ Frontend โ                โ  Backend โ                โ Supabase โ
โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ
     โ                           โ                           โ
     โ [Despuรฉs de explicaciรณn]  โ                           โ
     โ                           โ                           โ
     โ 1. Usuario escribe:       โ                           โ
     โ    "ยฟY en movimiento      โ                           โ
     โ     circular?"            โ                           โ
     โ                           โ                           โ
     โ 2. socket.emit(           โ                           โ
     โ    'ask_follow_up_        โ                           โ
     โ    question',             โ                           โ
     โ    {question: "...",      โ                           โ
     โ     related_to: "uuid"})  โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ                           โ
     โ                           โ 3. Obtener pregunta       โ
     โ                           โ    original               โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ                           โ
     โ                           โ 4. Normalizar + hash      โ
     โ                           โ                           โ
     โ                           โ 5. Buscar en cache        โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ                           โ
     โ                           โ 6. Si NO existe:          โ
     โ                           โ    Generar con IA         โ
     โ                           โ    (incluye contexto      โ
     โ                           โ     de pregunta original) โ
     โ                           โ                           โ
     โ 7. waiting_phrase         โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ
     โ                           โ 8. Guardar respuesta      โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ   INSERT INTO ai_answers  โ
     โ                           โ   related_question_id =   โ
     โ                           โ   "uuid_original"         โ
     โ                           โ                           โ
     โ 9. follow_up_start        โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ {answer_id: "uuid",       โ                           โ
     โ  is_follow_up: true}      โ                           โ
     โ                           โ                           โ
     โ [Streaming normal...]     โ                           โ
     โ                           โ                           โ
     โ 10. follow_up_complete    โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ
     โ 11. follow_up_options     โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ {options: [               โ                           โ
     โ   'more_questions',       โ                           โ
     โ   'finish']}              โ                           โ
```

---

## 6. Flujo de Interrupciรณn/Aclaraciรณn

```
โโโโโโโโโโโโ                โโโโโโโโโโโโ
โ Frontend โ                โ  Backend โ
โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ
     โ                           โ
     โ [Streaming en progreso]   โ
     โ                           โ
     โ 1. Usuario click          โ
     โ    "No entiendo X"        โ
     โ                           โ
     โ 2. socket.emit(           โ
     โ    'interrupt_            โ
     โ    explanation',          โ
     โ    {clarification_        โ
     โ     question: "...",      โ
     โ     current_context})     โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ
     โ                           โ 3. Pausar streaming       โ
     โ                           โ    principal              โ
     โ                           โ                           โ
     โ 4. clarification_start    โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ {is_brief: true,          โ                           โ
     โ  estimated_duration: 15}  โ                           โ
     โ                           โ                           โ
     โ                           โ 5. Generar aclaraciรณn     โ
     โ                           โ    breve con IA           โ
     โ                           โ                           โ
     โ 6. clarification_chunk    โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ (streaming rรกpido)        โ                           โ
     โ                           โ                           โ
     โ 7. clarification_complete โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ
     โ 8. clarification_options  โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ {options: [               โ                           โ
     โ   'continue',             โ                           โ
     โ   'new_question']}        โ                           โ
     โ                           โ                           โ
     โ 9. Usuario click          โ                           โ
     โ    "Continuar"            โ                           โ
     โ                           โ                           โ
     โ 10. socket.emit(          โ                           โ
     โ     'resume_explanation') โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ                           โ
     โ 11. explanation_resumed   โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ                           โ                           โ
     โ [Continรบa streaming       โ                           โ
     โ  principal]               โ                           โ
```

---

## 7. Gestiรณn de Sesiones Redis

```
โโโโโโโโโโโโ                โโโโโโโโโโโโ                โโโโโโโโโโโโ
โ  Socket  โ                โ  Session โ                โ   Redis  โ
โ  Event   โ                โ  Service โ                โ          โ
โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ
     โ                           โ                           โ
     โ connect                   โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ create_session()          โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ   HSET session:uuid       โ
     โ                           โ   user_id, connection_id  โ
     โ                           โ   EXPIRE session:uuid     โ
     โ                           โ   1800                    โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ   session_id              โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
     โ connection_established    โ                           โ
     โ                           โ                           โ
     โ [Actividad del usuario]   โ                           โ
     โ                           โ                           โ
     โ ask_question              โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ update_session()          โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ   HSET session:uuid       โ
     โ                           โ   current_question hash   โ
     โ                           โ   last_activity now       โ
     โ                           โ   EXPIRE session:uuid     โ
     โ                           โ   1800 (renovar TTL)      โ
     โ                           โ                           โ
     โ [30 minutos sin actividad]โ                           โ
     โ                           โ                           โ
     โ                           โ                           โ TTL expira
     โ                           โ                           โ Redis elimina
     โ                           โ                           โ automรกticamente
     โ                           โ                           โ
     โ disconnect                โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ end_session()             โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ   DEL session:uuid        โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
```

---

## 8. Cache de Respuestas IA

```
โโโโโโโโโโโโ                โโโโโโโโโโโโ                โโโโโโโโโโโโ
โ  Preguntaโ                โ  Backend โ                โ Supabase โ
โ  Usuario โ                โ          โ                โ ai_answersโ
โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ                โโโโโโฌโโโโโโ
     โ                           โ                           โ
     โ "ยฟQuรฉ es la energรญa       โ                           โ
     โ  cinรฉtica?"               โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ                           โ
     โ                           โ 1. Normalizar:            โ
     โ                           โ    "que es la energia     โ
     โ                           โ     cinetica"             โ
     โ                           โ                           โ
     โ                           โ 2. Hash SHA256:           โ
     โ                           โ    "a1b2c3d4..."          โ
     โ                           โ                           โ
     โ                           โ 3. Buscar en DB           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โ   SELECT * FROM           โ
     โ                           โ   ai_answers WHERE        โ
     โ                           โ   question_hash =         โ
     โ                           โ   'a1b2c3d4...'           โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ                           โ
     โ                           โ 4a. Si existe:            โ
     โ                           โ     - Incrementar uso     โ
     โ                           โ     - Retornar respuesta  โ
     โ                           โ                           โ
     โ                           โ 4b. Si NO existe:         โ
     โ                           โ     - Generar con IA      โ
     โ                           โ     - Guardar con hash    โ
     โ                           โ     - Retornar respuesta  โ
     โ                           โ                           โ
     โ [Otro usuario hace        โ                           โ
     โ  misma pregunta]          โ                           โ
     โ                           โ                           โ
     โ "Que es la Energรญa        โ                           โ
     โ  CINETICA?"               โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ                           โ
     โ                           โ                           โ
     โ                           โ Normalizar โ mismo hash   โ
     โ                           โ "a1b2c3d4..."             โ
     โ                           โ                           โ
     โ                           โ Buscar โ ENCONTRADO       โ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ                           โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                           โ                           โ
     โ Respuesta instantรกnea     โ                           โ
     โ (sin llamar a OpenAI)     โ                           โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโค                           โ
```

---

## Leyenda de Sรญmbolos

```
โ   Flujo vertical
โโโ Acciรณn/llamada
โโโค Respuesta/retorno
โผ   Continรบa hacia abajo
[...] Comentario/nota
```
